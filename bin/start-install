#!/bin/sh

########################################################################
# This script creates a virtual env and installs all python packages   #
# required in this course. The Caffe, Tensorflow,and Torch libraries   #
# are also installed for use in the final project.                     #
########################################################################

# Change this line if you cloned the course repository someplace else
export COURSE_REPO=~/comp150-02
cd ~/

mkdir ~/Envs
echo "export WORKON_HOME=~/Envs" >> ~/.bashrc
echo "source /usr/bin/virtualenvwrapper.sh" >> ~/.bashrc
source ~/.bashrc

# Make a virtualenv for this class
mkvirtualenv deep-venv
# This makes it so when you run 'workon deep-venv' the virtualenv is
# started and you cd into this course's rep
echo 'cd $COURSE_REPO' >> ~/Envs/deep-venv/bin/postactivate

# Note: to get out of a virtualenv run command deactivate
# Checking that the virtual env works
deactivate
workon deep-venv

# Install python math and science packages
pip install --upgrade pip
pip install --upgrade setuptools
pip install numpy 
pip install scipy
pip install matplotlib
pip install sklearn

# Install other course python requirements
cd $COURSE_REPO/bin
pip install -r requirements.txt

# Install Jupyter notebook app for in-browser coding
pip install jupyter

# Get Caffe
cd ~/
git clone https://github.com/BVLC/caffe.git
cp $COURSE_REPO/bin/aws_caffe_Makefile.config ~/caffe/Makefile.config

# Install python dependencies
cd caffe/python
pip install -r requirements.txt

# Install caffe
echo "export LD_LIBRARY_PATH=/usr/lib64/" >> ~/.bashrc
echo "export PYTHONPATH=~/caffe/python:$PYTHONPATH" >> ~/.bashrc
source ~/.bashrc
cd ..
make all
make test
# this is failing for some crazy reason
make runtest
make distribute

# check that everything works
python -c "import caffe"

# Install Tensorflow
export TF_BINARY_URL=https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow_gpu-0.12.1-cp27-none-linux_x86_64.whl

pip install --upgrade $TF_BINARY_URL

# check that everything works
python -c "import tensorflow"
