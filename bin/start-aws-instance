#!/bin/sh

########################################################################
# This script creates a virtual env and installs all python packages   #
# required in this course. The Caffe, Tensorflow,and Torch libraries   #
# are also installed for use in the final project.                     #
########################################################################
# install required system packages
sudo yum install python-devel python-pip python-wheel
sudo yum upgrade python-setuptools
sudo yum install protobuf-devel leveldb-devel snappy-devel opencv-devel boost-devel hdf5-devel gflags-devel glog-devel lmdb-devel
# gcc
sudo yum --setopt=group_package_types=mandatory,default,optional groupinstall "Development Tools"
gcc --version
# glog
wget https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/google-glog/glog-0.3.3.tar.gz
tar zxvf glog-0.3.3.tar.gz
cd glog-0.3.3
./configure
make && make install
# gflags
wget https://github.com/schuhschuh/gflags/archive/master.zip
unzip master.zip
cd gflags-master
mkdir build && cd build
export CXXFLAGS="-fPIC" && cmake .. && make VERBOSE=1
make && make install
# lmdb
git clone https://github.com/LMDB/lmdb
cd lmdb/libraries/liblmdb
make && make install
# atlas blas
sudo yum install atlas-devel
#cuda
uname -r
sudo yum install kernel-devel-$(uname -r) kernel-headers-$(uname -r)

wget http://developer.download.nvidia.com/compute/cuda/repos/rhel7/x86_64/cuda-repo-rhel7-8.0.44-1.x86_64.rpm
sudo rpm -i cuda-repo-rhel7-8.0.44-1.x86_64.rpm
sudo yum clean all
sudo yum install cuda

# virtualenv etc
sudo pip install virtualenv
sudo pip install virtualenvwrapper


# Install python math and science packages
sudo pip install --upgrade pip
sudo pip install --upgrade setuptools
sudo pip install numpy scipy matplotlib sklearn jupyter


# Get Caffe
cd ~/
git clone https://github.com/BVLC/caffe.git
cp caffe_Makefile.config ~/caffe/Makefile.config

# Install python dependencies
cd caffe/python
sudo pip install -r requirements.txt

# Install caffe
echo "export LD_LIBRARY_PATH=/usr/lib64/" >> ~/.bashrc
echo "export PYTHONPATH=~/caffe/python:$PYTHONPATH" >> ~/.bashrc
source ~/.bashrc
cd ..
make all
make test
# this is failing for some crazy reason
make runtest
make distribute

# check that everything works
python -c "import caffe"

# Install Tensorflow
export TF_BINARY_URL=https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow_gpu-0.12.1-cp27-none-linux_x86_64.whl

sudo pip install --upgrade $TF_BINARY_URL

# check that everything works
python -c "import tensorflow"
